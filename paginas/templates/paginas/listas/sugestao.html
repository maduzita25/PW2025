{% extends "paginas/index.html" %}

{% load static %}

{% block conteudo %}
<div class="mt-4">
    
    <!-- CabeÃ§alho -->
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h2 class="mb-0">
                <i class="bi bi-lightbulb"></i> SugestÃµes de Melhorias
            </h2>
            <p class="text-muted mb-0">{{ object_list.count }} sugestÃ£o{{ object_list.count|pluralize }}</p>
        </div>
        <div class="col-md-4 text-end">
            <a class="btn btn-primary" href="{% url 'inserir-sugestao' %}">
                <i class="bi bi-plus-circle"></i> Nova SugestÃ£o
            </a>
        </div>
    </div>

    <!-- Barra de Controle -->
    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body">
            <div class="row g-3">
                <!-- Busca -->
                <div class="col-md-6 col-lg-4">
                    <input type="text" class="form-control" id="searchSugestao" placeholder="ğŸ” Buscar sugestÃ£o..." >
                </div>

                <!-- Filtro por Status -->
                <div class="col-md-6 col-lg-3">
                    <select class="form-select" id="filterStatus">
                        <option value="">ğŸ“Š Todos os Status</option>
                        <option value="aberta">ğŸŸ¢ Aberta</option>
                        <option value="analise">ğŸŸ¡ Em AnÃ¡lise</option>
                        <option value="andamento">ğŸ”µ Em Andamento</option>
                        <option value="concluida">âœ… ConcluÃ­da</option>
                        <option value="rejeitada">âŒ Rejeitada</option>
                    </select>
                </div>

                <!-- Filtro por Prioridade -->
                <div class="col-md-6 col-lg-3">
                    <select class="form-select" id="filterPrioridade">
                        <option value="">â­ Todas as Prioridades</option>
                        <option value="alta">ğŸ”´ Alta</option>
                        <option value="media">ğŸŸ  MÃ©dia</option>
                        <option value="baixa">ğŸŸ¢ Baixa</option>
                    </select>
                </div>

                <!-- OrdenaÃ§Ã£o -->
                <div class="col-md-6 col-lg-2">
                    <select class="form-select" id="sortBy">
                        <option value="recentes">ğŸ“… Mais Recentes</option>
                        <option value="antigas">ğŸ“… Mais Antigas</option>
                        <option value="votos">ğŸ—³ï¸ Mais Votadas</option>
                        <option value="comentarios">ğŸ’¬ Mais Comentadas</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- EstatÃ­sticas RÃ¡pidas -->
    <div class="row g-3 mb-4 justify-content-center">
        <div class="col-md-3 col-lg-2">
            <div class="card text-center border-0 shadow-sm bg-light">
                <div class="card-body p-2">
                    <h6 class="card-title text-muted mb-1">Total</h6>
                    <h4 class="text-primary mb-0">{{ object_list.count }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card text-center border-0 shadow-sm bg-light">
                <div class="card-body p-2">
                    <h6 class="card-title text-muted mb-1">Abertas</h6>
                    <h4 class="text-success mb-0" id="countAberta">0</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card text-center border-0 shadow-sm bg-light">
                <div class="card-body p-2">
                    <h6 class="card-title text-muted mb-1">AnÃ¡lise</h6>
                    <h4 class="text-warning mb-0" id="countAnalise">0</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-2">
            <div class="card text-center border-0 shadow-sm bg-light">
                <div class="card-body p-2">
                    <h6 class="card-title text-muted mb-1">ConcluÃ­das</h6>
                    <h4 class="text-info mb-0" id="countConcluida">0</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de SugestÃµes -->
    {% if object_list %}
        <div class="row g-3" id="sugestoesContainer">
            {% for sugestao in object_list %}
            <div class="col-md-6 col-lg-4 sugestao-card" data-status="{{ sugestao.status }}" data-prioridade="{{ sugestao.prioridade|lower }}" data-titulo="{{ sugestao.titulo|lower }}">
                <div class="card h-100 shadow border">
                    <!-- Badge de Status no topo -->
                    <div class="card-header bg-transparent border-0 pb-0 pt-3 px-3">
                        <div class="d-flex justify-content-between align-items-start gap-2">
                            <!-- Status Badge -->
                            {% if sugestao.status == 'aberta' %}
                                <span class="badge bg-success">ğŸŸ¢ Aberta</span>
                            {% elif sugestao.status == 'analise' %}
                                <span class="badge bg-warning">ğŸŸ¡ Em AnÃ¡lise</span>
                            {% elif sugestao.status == 'andamento' %}
                                <span class="badge bg-info">ğŸ”µ Em Andamento</span>
                            {% elif sugestao.status == 'concluida' %}
                                <span class="badge bg-primary">âœ… ConcluÃ­da</span>
                            {% elif sugestao.status == 'rejeitada' %}
                                <span class="badge bg-danger">âŒ Rejeitada</span>
                            {% endif %}

                            <!-- Prioridade Badge -->
                            {% if sugestao.prioridade == 'alta' %}
                                <span class="badge bg-danger-subtle text-danger">ğŸ”´ Alta</span>
                            {% elif sugestao.prioridade == 'media' %}
                                <span class="badge bg-warning-subtle text-warning">ğŸŸ  MÃ©dia</span>
                            {% elif sugestao.prioridade == 'baixa' %}
                                <span class="badge bg-info-subtle text-info">ğŸŸ¢ Baixa</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Corpo do Card -->
                    <div class="card-body">
                        <!-- TÃ­tulo -->
                        <h5 class="card-title text-dark mb-2">{{ sugestao.titulo }}</h5>

                        <!-- Campus e Categoria com o justify between -->
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">
                                <i class="bi bi-geo-alt"></i> {{ sugestao.campus.nome }}
                            </span>
                            <span class="text-muted">
                                <i class="bi bi-tag"></i> {{ sugestao.categoria.nome }}
                            </span>
                        </div>

                        <!-- DescriÃ§Ã£o truncada -->
                        <p class="card-text text-muted small" title="{{ sugestao.descricao }}">
                            {{ sugestao.descricao|truncatechars:90 }}
                        </p>

                        <!-- Info Line 1: Data e Autor -->
                        <div class="row g-2 mb-2 small">
                            <div class="col-6">
                                <i class="bi bi-calendar-event text-muted"></i>
                                <span class="text-muted">{{ sugestao.data_criacao|date:"d/m/Y" }}</span>
                            </div>
                            <div class="col-6 text-end">
                                <i class="bi bi-person-circle text-muted"></i>
                                <span class="text-muted">{{ sugestao.usuario.username }}</span>
                            </div>
                        </div>

                        <!-- Votos e ComentÃ¡rios -->
                        <div class="row g-2 p-2 bg-light rounded-2 mb-3">
                            <div class="col-6 text-center">
                                <div class="d-flex align-items-center justify-content-center gap-1">
                                    <span class="fs-4">ğŸ‘</span>
                                    <span class="fs-4 text-success fw-bold">{{ sugestao.votos_sim }}</span>
                                </div>
                                <small class="text-muted">Concordam</small>
                            </div>
                            <div class="col-6 text-center border-start">
                                <div class="d-flex align-items-center justify-content-center gap-1">
                                    <span class="fs-4">ğŸ‘</span>
                                    <span class="fs-4 text-danger fw-bold">{{ sugestao.votos_nao }}</span>
                                </div>
                                <small class="text-muted">Discordam</small>
                            </div>
                        </div>

                        <!-- ComentÃ¡rios -->
                        <div class="alert alert-light mb-3 py-2 px-2 d-flex align-items-center gap-2">
                            <i class="bi bi-chat-dots text-info"></i>
                            <small>
                                <strong>{{ sugestao.comentarios.count }}</strong> 
                                comentÃ¡rio{{ sugestao.comentarios.count|pluralize }}
                            </small>
                        </div>

                        <!-- BotÃµes de AÃ§Ã£o -->
                        <div class="d-flex flex-column gap-2">
                            <a class="btn btn-outline-success btn-sm" href="{% url 'ver-sugestao' sugestao.pk %}">
                                <i class="bi bi-eye"></i> Ver Detalhes
                            </a>
                            <div class="btn-group w-100" role="group">
                                <a class="btn btn-outline-primary btn-sm" href="{% url 'inserir-voto-sugestao' sugestao.pk %}" title="Adicionar voto">
                                    <i class="bi bi-hand-thumbs-up"></i> Votar
                                </a>
                                <a class="btn btn-outline-warning btn-sm" href="{% url 'editar-sugestao' sugestao.pk %}" title="Editar sugestÃ£o">
                                    <i class="bi bi-pencil"></i> Editar
                                </a>
                                <a class="btn btn-outline-danger btn-sm" href="{% url 'excluir-sugestao' sugestao.pk %}" title="Excluir sugestÃ£o">
                                    <i class="bi bi-trash"></i> Excluir
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Script de Filtro e Busca -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const searchInput = document.getElementById('searchSugestao');
                const statusFilter = document.getElementById('filterStatus');
                const prioridadeFilter = document.getElementById('filterPrioridade');
                const sortBySelect = document.getElementById('sortBy');
                const sugestoesContainer = document.getElementById('sugestoesContainer');
                const cards = document.querySelectorAll('.sugestao-card');

                function filterAndSort() {
                    const searchTerm = searchInput.value.toLowerCase();
                    const selectedStatus = statusFilter.value;
                    const selectedPrioridade = prioridadeFilter.value;
                    const sortBy = sortBySelect.value;

                    // Filtrar
                    let visibleCards = Array.from(cards).filter(card => {
                        const titulo = card.dataset.titulo;
                        const status = card.dataset.status;
                        const prioridade = card.dataset.prioridade;

                        const matchSearch = titulo.includes(searchTerm);
                        const matchStatus = !selectedStatus || status === selectedStatus;
                        const matchPrioridade = !selectedPrioridade || prioridade === selectedPrioridade;

                        return matchSearch && matchStatus && matchPrioridade;
                    });

                    // Ordenar
                    visibleCards.sort((a, b) => {
                        // Adicionar data e votos como data attributes para ordenaÃ§Ã£o
                        // Por enquanto apenas reordenar por visibilidade
                        return 0;
                    });

                    // Atualizar visibilidade
                    cards.forEach(card => {
                        card.style.display = visibleCards.includes(card) ? '' : 'none';
                    });

                    // Atualizar contadores
                    updateCounters();

                    // Mensagem de nenhum resultado
                    const noResults = visibleCards.length === 0;
                    if (noResults) {
                        if (!document.getElementById('noResults')) {
                            const noResultsDiv = document.createElement('div');
                            noResultsDiv.id = 'noResults';
                            noResultsDiv.className = 'col-12';
                            noResultsDiv.innerHTML = '<div class="alert alert-info text-center"><i class="bi bi-info-circle"></i> Nenhuma sugestÃ£o encontrada com esses filtros.</div>';
                            sugestoesContainer.appendChild(noResultsDiv);
                        }
                    } else {
                        const noResultsDiv = document.getElementById('noResults');
                        if (noResultsDiv) {
                            noResultsDiv.remove();
                        }
                    }
                }

                function updateCounters() {
                    const allCards = document.querySelectorAll('.sugestao-card:not([style*="display: none"])');
                    let countAberta = 0, countAnalise = 0, countConcluida = 0;

                    allCards.forEach(card => {
                        const status = card.dataset.status;
                        if (status === 'aberta') countAberta++;
                        else if (status === 'analise') countAnalise++;
                        else if (status === 'concluida') countConcluida++;
                    });

                    document.getElementById('countAberta').textContent = countAberta;
                    document.getElementById('countAnalise').textContent = countAnalise;
                    document.getElementById('countConcluida').textContent = countConcluida;
                }

                // Event listeners
                searchInput.addEventListener('keyup', filterAndSort);
                statusFilter.addEventListener('change', filterAndSort);
                prioridadeFilter.addEventListener('change', filterAndSort);
                sortBySelect.addEventListener('change', filterAndSort);

                // Inicializar contadores
                updateCounters();
            });
        </script>

    {% else %}
        <!-- Nenhuma sugestÃ£o -->
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div class="card border-0 shadow-sm text-center py-5">
                    <div class="card-body">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
                        <h4 class="mt-3 text-muted">Nenhuma sugestÃ£o cadastrada</h4>
                        <p class="text-muted mb-3">Seja o primeiro a compartilhar uma ideia de melhoria!</p>
                        <a class="btn btn-primary btn-lg" href="{% url 'inserir-sugestao' %}">
                            <i class="bi bi-plus-circle"></i> Criar SugestÃ£o
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

</div>

{% endblock %}
