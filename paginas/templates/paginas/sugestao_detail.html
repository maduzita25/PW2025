{% extends "paginas/index.html" %}

{% load static %}

{% block conteudo %}
<div class="sugestao-detail-container mt-4 mb-5">
    
    <!-- Cabe√ßalho da Sugest√£o -->
    <div class="row mb-4">
        
        <div class="col-lg-8">


            <div class="card shadow border-0">
                <div class="card-body">
                    <!-- T√≠tulo -->
                    <h1 class="card-title mb-3">{{ sugestao.titulo }}</h1>
                    
                    <!-- Informa√ß√µes b√°sicas em linha -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="mb-3">
                                <strong>üìç Campus:</strong> <br> 
                                <span class="fs-4">{{ sugestao.campus.nome }}</span>
                            </p>
                            <p class="mb-3">
                                <strong>üè∑Ô∏è Categoria:</strong> <br>
                                <span class="fs-4">{{ sugestao.categoria.nome }}</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-3">
                                <strong>üìÖ Data:</strong> <br>
                                <span class="fs-4">{{ sugestao.data_criacao|date:"d/m/Y H:i" }}</span>
                            </p>
                            <p class="mb-3">
                                <strong>üë§ Autor:</strong> <br>
                                <span class="text-muted fs-4">{{ sugestao.usuario.username }}</span>
                            </p>
                        </div>
                    </div>

                    <!-- Status e Prioridade -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="mb-0">
                                <strong>üìä Status:</strong>
                                {% if sugestao.status == 'aberta' %}
                                    <span class="badge bg-success">Aberta</span>
                                {% elif sugestao.status == 'analise' %}
                                    <span class="badge bg-warning">Em An√°lise</span>
                                {% elif sugestao.status == 'andamento' %}
                                    <span class="badge bg-info">Em Andamento</span>
                                {% elif sugestao.status == 'concluida' %}
                                    <span class="badge bg-primary">Conclu√≠da</span>
                                {% elif sugestao.status == 'rejeitada' %}
                                    <span class="badge bg-danger">Rejeitada</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-0">
                                <strong>‚≠ê Prioridade:</strong>
                                {% if sugestao.prioridade == 'alta' %}
                                    <span class="badge bg-danger">Alta</span>
                                {% elif sugestao.prioridade == 'media' %}
                                    <span class="badge bg-warning">M√©dia</span>
                                {% elif sugestao.prioridade == 'baixa' %}
                                    <span class="badge bg-info">Baixa</span>
                                {% else %}
                                    <span class="badge bg-light text-dark">N√£o definida</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Descri√ß√£o -->
                    <hr>
                    <div class="my-3">
                        <h5 class="text-dark mb-2">üìù Descri√ß√£o</h5>
                        <p class="text-muted fs-5" style="white-space: pre-wrap;">{{ sugestao.descricao }}</p>
                    </div>

                    <!-- Anexos -->
                    {% if sugestao.anexos %}
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="mb-2">üìé Anexos</h6>
                        <a href="{{ sugestao.anexos.url }}" class="btn btn-sm btn-outline-secondary" download>
                            <i class="bi bi-download"></i> Baixar Anexo
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card shadow border-0 mt-5">
                <div class="card-body">
                    <h5 class="card-title mb-3">‚öôÔ∏è A√ß√µes</h5>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{% url 'listar-sugestao' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Voltar √† Lista
                        </a>
                        {% if eh_autor %}
                            <a href="{% url 'editar-sugestao' sugestao.pk %}" class="btn btn-warning">
                                <i class="bi bi-pencil"></i> Editar
                            </a>
                            <a href="{% url 'excluir-sugestao' sugestao.pk %}" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Excluir
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>

        </div> <!-- fim da coluna -->

        <!-- Painel lateral com Votos -->
        <div class="col-lg-4">
            <div class="card shadow border-0 mb-3 sticky-top" style="top: 100px;">
                <div class="card-body">
                    <h5 class="card-title text-center mb-3">üó≥Ô∏è Vota√ß√£o</h5>
                    
                    <!-- Gr√°fico de votos -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <strong class="text-success">üëç Concordo</strong>
                            <span id="votos-sim" class="badge bg-success">{{ votos_sim }}</span>
                        </div>
                        <div id="progress-sim" class="progress mb-2" role="progressbar" aria-valuenow="{{ porcentagem_sim }}" aria-valuemin="0" aria-valuemax="100">
                            <div id="progress-bar-sim" class="progress-bar bg-success" style="width: {{ porcentagem_sim|floatformat:1 }}%"></div>
                        </div>
                        <small id="pct-sim" class="text-muted">{{ porcentagem_sim|floatformat:1 }}%</small>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <strong class="text-danger">üëé Discordo</strong>
                            <span id="votos-nao" class="badge bg-danger">{{ votos_nao }}</span>
                        </div>
                        <div id="progress-nao" class="progress mb-2" role="progressbar" aria-valuenow="{{ porcentagem_nao }}" aria-valuemin="0" aria-valuemax="100">
                            <div id="progress-bar-nao" class="progress-bar bg-danger" style="width: {{ porcentagem_nao|floatformat:1 }}%"></div>
                        </div>
                        <small id="pct-nao" class="text-muted">{{ porcentagem_nao|floatformat:1 }}%</small>
                    </div>

                    <div class="alert alert-info alert-sm mb-3">
                        <strong>Total de votos:</strong> <span id="total-votos">{{ total_votos }}</span>
                    </div>

                    <!-- Mensagem de voto -->
                    {% if usuario_votou %}
                        {% if voto_usuario.escolha %}
                            <div class="alert alert-success alert-sm mb-2">
                                <i class="bi bi-check-circle"></i> Voc√™ concordou com esta sugest√£o
                            </div>
                        {% else %}
                            <div class="alert alert-danger alert-sm mb-2">
                                <i class="bi bi-x-circle"></i> Voc√™ discordou desta sugest√£o
                            </div>
                        {% endif %}
                        <p class="text-center">
                            <a href="{% url 'editar-voto' voto_usuario.pk %}" class="btn btn-sm btn-warning">
                                <i class="bi bi-pencil"></i> Mudar voto
                            </a>
                        </p>
                    {% else %}
                        <p class="text-center" id="voto-area">
                            <button type="button" class="btn btn-success btn-votar w-100 mb-2" data-escolha="true" data-sugestao="{{ sugestao.pk }}">
                                <i class="bi bi-hand-thumbs-up"></i> Concordo
                            </button>
                            <button type="button" class="btn btn-danger btn-votar w-100" data-escolha="false" data-sugestao="{{ sugestao.pk }}">
                                <i class="bi bi-hand-thumbs-down"></i> Discordo
                            </button>
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Coment√°rios -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow border-0 mb-3">
                <div class="card-body">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-chat-dots"></i> Coment√°rios 
                        <span id="comentarios-count" class="badge bg-primary">{{ comentarios.count }}</span>
                    </h5>

                    <!-- Formul√°rio de novo coment√°rio -->
                    <div class="mb-4 pb-3 border-bottom">
                        <h6 class="mb-2">Adicionar coment√°rio:</h6>
                        <form id="form-comentario" method="POST" action="{% url 'inserir-comentario' %}" class="d-flex flex-column gap-2">
                            {% csrf_token %}
                            <input type="hidden" name="sugestao" id="comentario-sugestao" value="{{ sugestao.pk }}">
                            <textarea 
                                id="comentario-texto"
                                name="texto" 
                                class="form-control" 
                                placeholder="Compartilhe sua opini√£o sobre esta sugest√£o..." 
                                rows="3" 
                                required
                            ></textarea>
                            <button type="submit" id="btn-enviar-comentario" class="btn btn-primary align-self-end">
                                <i class="bi bi-send"></i> Enviar Coment√°rio
                            </button>
                        </form>
                    </div>

                    <!-- Lista de coment√°rios -->
                    {% if comentarios %}
                        <div class="comentarios-lista">
                            {% for comentario in comentarios %}
                            <div class="mb-3 p-3 bg-light rounded-2 border-start border-3 border-primary">
                                <!-- Cabe√ßalho do coment√°rio -->
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <strong class="text-dark">{{ comentario.usuario.username }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            <i class="bi bi-calendar-event"></i> 
                                            {{ comentario.data_comentario|date:"d/m/Y H:i" }}
                                        </small>
                                    </div>
                                    {% if request.user == comentario.usuario %}
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            <i class="bi bi-three-dots"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" style="background-color: #f8f9fa !important;">
                                            <li>
                                                <a class="dropdown-item" href="{% url 'editar-comentario' comentario.pk %}">
                                                    <i class="bi bi-pencil"></i> Editar
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item text-danger" href="{% url 'excluir-comentario' comentario.pk %}">
                                                    <i class="bi bi-trash"></i> Excluir
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Texto do coment√°rio -->
                                <p class="mb-0 text-dark" style="white-space: pre-wrap;">{{ comentario.texto }}</p>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info text-center">
                            <i class="bi bi-info-circle"></i> Nenhum coment√°rio ainda. Seja o primeiro a comentar!
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<style>
    .sugestao-detail-container {
        margin-top: 60px;
    }

    .card {
        transition: all 0.3s ease;
    }

    .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }

    .badge {
        font-size: 0.85rem;
        padding: 0.35rem 0.65rem;
    }

    .alert-sm {
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
        margin-bottom: 0;
    }

    .comentarios-lista {
        max-height: 600px;
        overflow-y: auto;
    }

    .border-start {
        border-left-width: 4px !important;
    }

    .progress {
        height: 20px;
    }

    .btn {
        transition: all 0.2s ease;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 991px) {
        .sticky-top {
            position: relative !important;
            top: 0 !important;
        }
    }
</style>

{% endblock %}

{% block extra_js %}
<script>
    // Pegar cookie CSRF (fun√ß√£o padr√£o Django)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    $(function() {
        const csrftoken = getCookie('csrftoken');

        $('.btn-votar').on('click', function(e) {
            e.preventDefault();
            const btn = $(this);
            const escolha = btn.data('escolha');
            const sugestaoId = btn.data('sugestao');

            // Desabilitar bot√µes temporariamente
            $('.btn-votar').prop('disabled', true);

            $.ajax({
                url: "{% url 'ajax-votar-sugestao' %}",
                method: 'POST',
                data: {
                    sugestao: sugestaoId,
                    escolha: escolha
                },
                headers: {
                    'X-CSRFToken': csrftoken
                },
                success: function(resp) {
                    if (resp.success) {
                        // Atualiza contadores
                        $('#votos-sim').text(resp.votos_sim);
                        $('#votos-nao').text(resp.votos_nao);
                        $('#total-votos').text(resp.total_votos);
                        $('#progress-bar-sim').css('width', resp.porcentagem_sim + '%');
                        $('#progress-bar-nao').css('width', resp.porcentagem_nao + '%');
                        $('#pct-sim').text(resp.porcentagem_sim + '%');
                        $('#pct-nao').text(resp.porcentagem_nao + '%');

                        // Substitui √°rea de voto por mensagem do usu√°rio
                        let mensagem = '';
                        if (resp.escolha_usuario) {
                            mensagem = '<div class="alert alert-success alert-sm mb-2"><i class="bi bi-check-circle"></i> Voc√™ concordou com esta sugest√£o</div>';
                        } else {
                            mensagem = '<div class="alert alert-danger alert-sm mb-2"><i class="bi bi-x-circle"></i> Voc√™ discordou desta sugest√£o</div>';
                        }

                        mensagem += '<p class="text-center"><a href="#" class="btn btn-sm btn-warning" id="btn-mudar-voto"><i class="bi bi-pencil"></i> Mudar voto</a></p>';

                        $('#voto-area').html(mensagem);
                    } else {
                        alert(resp.error || 'Erro ao registrar voto');
                        $('.btn-votar').prop('disabled', false);
                    }
                },
                error: function(xhr) {
                    let msg = 'Erro na requisi√ß√£o.';
                    if (xhr.responseJSON && xhr.responseJSON.error) msg = xhr.responseJSON.error;
                    alert(msg);
                    $('.btn-votar').prop('disabled', false);
                }
            });
        });

        // Handler para 'mudar voto' (abre a p√°gina de edi√ß√£o de voto)
        $(document).on('click', '#btn-mudar-voto', function(e) {
            e.preventDefault();
            // redireciona para a p√°gina de edi√ß√£o de voto (se existir)
            // Tentamos montar a URL a partir do contexto: editar-voto precisa do pk do voto, que n√£o temos aqui.
            // Simples fallback: redirecionar para listar votos para o usu√°rio.
            window.location.href = "{% url 'listar-voto' %}";
        });
    });
</script>
{% endblock %}
